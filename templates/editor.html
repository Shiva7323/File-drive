{% extends "base.html" %}

{% block title %}Edit {{ file.original_filename }} - File Drive{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/material-darker.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/material.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.css">
<style>
.editor-container {
    height: calc(100vh - 140px);
}

.CodeMirror {
    height: 100%;
    border-radius: 8px;
}

.editor-toolbar {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.editor-toolbar .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.file-info {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.status-indicator {
    height: 10px;
    width: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.status-saved { background: #28a745; }
.status-saving { background: #ffc107; }
.status-error { background: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- File Info Bar -->
            <div class="file-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ file.original_filename }}</h5>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Last modified: {{ file.updated_at.strftime('%b %d, %Y at %H:%M') }}
                        </small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-saved" id="saveStatus"></span>
                        <span id="saveStatusText">Saved</span>
                        <a href="{{ url_for('files') }}" class="btn btn-outline-secondary ms-3">
                            <i class="fas fa-arrow-left me-2"></i>Back to Files
                        </a>
                    </div>
                </div>
            </div>

            <!-- Editor Toolbar -->
            <div class="editor-toolbar">
                <div class="row">
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="saveFile()">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePreview()">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="formatCode()">
                                <i class="fas fa-magic me-1"></i>Format
                            </button>
                        </div>
                        
                        <div class="btn-group ms-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('**Bold Text**')">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('*Italic Text*')">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('[Link Text](URL)')">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="insertText('```\nCode Block\n```')">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="increaseFontSize()">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="decreaseFontSize()">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">
                                <i class="fas fa-palette"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleWordWrap()">
                                <i class="fas fa-align-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Editor Container -->
            <div class="editor-container">
                <div class="row h-100">
                    <div class="col-md-6 h-100" id="editorColumn">
                        <textarea id="fileEditor" class="form-control h-100">{{ file_content }}</textarea>
                    </div>
                    <div class="col-md-6 h-100 d-none" id="previewColumn">
                        <div class="glass-card h-100 p-3" id="previewPane">
                            <h6>Preview</h6>
                            <div id="previewContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/markdown/markdown.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/python/python.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/xml/xml.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/css/css.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/anyword-hint.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>

<script>
let editor;
let isDarkTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark';
let isPreviewMode = false;
let saveTimeout;

// Initialize CodeMirror editor
document.addEventListener('DOMContentLoaded', function() {
    const fileExtension = '{{ file.original_filename }}'.split('.').pop().toLowerCase();
    let mode = 'text/plain';
    
    // Set appropriate mode based on file extension
    switch(fileExtension) {
        case 'md': mode = 'markdown'; break;
        case 'js': mode = 'javascript'; break;
        case 'py': mode = 'python'; break;
        case 'html': mode = 'text/html'; break;
        case 'css': mode = 'css'; break;
        case 'json': mode = 'application/json'; break;
    }
    
    editor = CodeMirror.fromTextArea(document.getElementById('fileEditor'), {
        mode: mode,
        theme: isDarkTheme ? 'material-darker' : 'material',
        lineNumbers: true,
        lineWrapping: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 4,
        tabSize: 4,
        extraKeys: {
            'Ctrl-S': function() { saveFile(); },
            'Cmd-S': function() { saveFile(); },
            'Ctrl-/': 'toggleComment',
            'Cmd-/': 'toggleComment'
        }
    });
    
    // Auto-save on change
    editor.on('change', function() {
        updateSaveStatus('saving');
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(autoSave, 2000);
    });
    
    // Update preview in real-time for markdown
    if (mode === 'markdown') {
        editor.on('change', updatePreview);
        updatePreview();
    }
});

function saveFile() {
    const content = editor.getValue();
    updateSaveStatus('saving');
    
    fetch(`{{ url_for('edit_file', file_id=file.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'content=' + encodeURIComponent(content)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSaveStatus('saved');
        } else {
            updateSaveStatus('error');
        }
    })
    .catch(error => {
        updateSaveStatus('error');
        console.error('Save error:', error);
    });
}

function autoSave() {
    saveFile();
}

function updateSaveStatus(status) {
    const indicator = document.getElementById('saveStatus');
    const text = document.getElementById('saveStatusText');
    
    indicator.className = 'status-indicator status-' + status;
    switch(status) {
        case 'saved': text.textContent = 'Saved'; break;
        case 'saving': text.textContent = 'Saving...'; break;
        case 'error': text.textContent = 'Save Error'; break;
    }
}

function togglePreview() {
    const editorCol = document.getElementById('editorColumn');
    const previewCol = document.getElementById('previewColumn');
    
    if (isPreviewMode) {
        editorCol.className = 'col-md-6 h-100';
        previewCol.className = 'col-md-6 h-100 d-none';
        isPreviewMode = false;
    } else {
        editorCol.className = 'col-md-6 h-100';
        previewCol.className = 'col-md-6 h-100';
        updatePreview();
        isPreviewMode = true;
    }
    
    // Refresh editor
    setTimeout(() => editor.refresh(), 100);
}

function updatePreview() {
    if (!isPreviewMode) return;
    
    const content = editor.getValue();
    const previewContent = document.getElementById('previewContent');
    
    if ('{{ file.original_filename }}'.endsWith('.md')) {
        previewContent.innerHTML = marked.parse(content);
    } else {
        previewContent.innerHTML = '<pre>' + content + '</pre>';
    }
}

function formatCode() {
    const content = editor.getValue();
    const fileExtension = '{{ file.original_filename }}'.split('.').pop().toLowerCase();
    
    // Basic formatting for different file types
    if (fileExtension === 'json') {
        try {
            const formatted = JSON.stringify(JSON.parse(content), null, 2);
            editor.setValue(formatted);
        } catch (e) {
            alert('Invalid JSON format');
        }
    }
    // Add more formatting options as needed
}

function insertText(text) {
    const doc = editor.getDoc();
    const cursor = doc.getCursor();
    doc.replaceRange(text, cursor);
    editor.focus();
}

function increaseFontSize() {
    const currentSize = parseInt(getComputedStyle(document.querySelector('.CodeMirror')).fontSize);
    document.querySelector('.CodeMirror').style.fontSize = (currentSize + 2) + 'px';
    editor.refresh();
}

function decreaseFontSize() {
    const currentSize = parseInt(getComputedStyle(document.querySelector('.CodeMirror')).fontSize);
    if (currentSize > 10) {
        document.querySelector('.CodeMirror').style.fontSize = (currentSize - 2) + 'px';
        editor.refresh();
    }
}

function toggleTheme() {
    isDarkTheme = !isDarkTheme;
    editor.setOption('theme', isDarkTheme ? 'material-darker' : 'material');
}

function toggleWordWrap() {
    const currentWrap = editor.getOption('lineWrapping');
    editor.setOption('lineWrapping', !currentWrap);
}

// Keyboard shortcuts info
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveFile();
    }
});
</script>
{% endblock %}